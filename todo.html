<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Todo List</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="todo-container">
        <header>
            <h1>My Todo List</h1>
            <div class="user-info">
                <span id="usernameDisplay"></span>
                <a href="#" id="logoutBtn" class="logout-btn">Logout</a>
            </div>
        </header>
        
        <div class="add-task">
            <input type="text" id="newTask" placeholder="Add a new task...">
            <button id="addTaskBtn" class="btn">Add</button>
        </div>
        
        <div class="task-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="active">Active</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
        </div>
        
        <ul id="taskList">
            <!-- Tasks will be loaded here dynamically -->
        </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const usernameDisplay = document.getElementById('usernameDisplay');
            const logoutBtn = document.getElementById('logoutBtn');
            const newTaskInput = document.getElementById('newTask');
            const addTaskBtn = document.getElementById('addTaskBtn');
            const taskList = document.getElementById('taskList');
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            let currentFilter = 'all';
            
            // Check if user is logged in
            checkAuth();
            
            // Display username
            function checkAuth() {
                fetch('../backend/get_tasks.php')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success && data.message === 'Unauthorized access') {
                            window.location.href = 'index.html';
                        } else {
                            usernameDisplay.textContent = `Welcome, ${data.username || 'User'}`;
                            loadTasks();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        window.location.href = 'index.html';
                    });
            }
            
            // Load tasks based on current filter
            function loadTasks() {
                fetch(`../backend/get_tasks.php?filter=${currentFilter}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderTasks(data.tasks);
                        }
                    });
            }
            
            // Render tasks to the DOM
            function renderTasks(tasks) {
                taskList.innerHTML = '';
                
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    if (task.is_completed) {
                        li.classList.add('completed');
                    }
                    
                    li.innerHTML = `
                        <input type="checkbox" ${task.is_completed ? 'checked' : ''} data-id="${task.id}">
                        <span class="task-text">${task.task_text}</span>
                        <button class="delete-btn" data-id="${task.id}">Ã—</button>
                    `;
                    
                    taskList.appendChild(li);
                });
                
                // Add event listeners
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', toggleTask);
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', deleteTask);
                });
            }
            
            // Add new task
            function addTask() {
                const taskText = newTaskInput.value.trim();
                if (!taskText) return;
                
                fetch('../backend/add_task.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ task_text: taskText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        newTaskInput.value = '';
                        if (currentFilter !== 'completed') {
                            loadTasks();
                        }
                    }
                });
            }
            
            // Toggle task completion
            function toggleTask(e) {
                const taskId = e.target.dataset.id;
                const isCompleted = e.target.checked;
                
                fetch('../backend/update_task.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        task_id: taskId,
                        is_completed: isCompleted 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTasks();
                    }
                });
            }
            
            // Delete task
            function deleteTask(e) {
                const taskId = e.target.dataset.id;
                
                fetch('../backend/delete_task.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ task_id: taskId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTasks();
                    }
                });
            }
            
            // Logout
            function logout() {
                fetch('../backend/logout.php')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = 'index.html';
                        }
                    });
            }
            
            // Event listeners
            addTaskBtn.addEventListener('click', addTask);
            newTaskInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addTask();
            });
            
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    loadTasks();
                });
            });
            
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                logout();
            });
        });
    </script>
</body>
</html>